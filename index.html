<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Aero Dash ‚Äî Ultimate Runner (Single-File)</title>
<meta name="theme-color" content="#0b0f1a">
<style>
  :root{
    --bg:#0b0f1a; --bg2:#0a0d17; --panel:#121a2b; --ink:#eaf2ff; --muted:#8fa3c1; --accent:#5ac8fa; --accent2:#ff8a5c;
    --good:#2ecc71; --bad:#ff5d73; --gold:#ffd54a; --violet:#b97cff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% -200px,#101a33 0%,#0b0f1a 60%);}
  body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);display:flex;justify-content:center;align-items:center}
  .app{width:min(100vw,860px);height:min(100vh,1280px);max-height:100vh;display:grid;grid-template-rows:auto 1fr auto;gap:10px;padding:10px}
  header,footer{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:8px 10px;backdrop-filter:blur(8px)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .pill b{color:var(--ink)}
  .wrap{position:relative;border-radius:14px;border:1px solid rgba(255,255,255,.08);overflow:hidden;background:linear-gradient(180deg,#0d1426,#0a0e18)}
  canvas{display:block;width:100%;height:100%}
  button{cursor:pointer;border:0;border-radius:12px;padding:9px 12px;font-weight:800;background:var(--accent);color:#001018;transition:.15s transform}
  button.secondary{background:rgba(255,255,255,.07);color:var(--ink);border:1px solid rgba(255,255,255,.12)}
  button.warn{background:var(--accent2);color:#2b1000}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,.15);color:var(--muted)}
  button:active{transform:translateY(1px)}
  .overlay{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;padding:16px;pointer-events:none}
  .panel{pointer-events:auto;background:var(--panel);border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.5);padding:18px;max-width:95%;text-align:center}
  .panel h1{margin:0 0 6px;font-size:24px}
  .panel p{margin:6px 0 12px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .shop{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:10px}
  .skin{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:12px;padding:10px}
  .skin .preview{height:54px;border-radius:8px;margin-bottom:8px;display:grid;place-items:center;font-weight:900;color:#001018}
  .skin .meta{display:flex;justify-content:space-between;align-items:center;font-size:12px}
  .coin{color:var(--gold);font-weight:800}
  .muted{color:var(--muted)}
  .top{position:absolute;top:6px;left:6px;right:6px;display:flex;justify-content:space-between;gap:6px;pointer-events:none}
  .hud{display:flex;gap:6px}
  .hud .pill{pointer-events:auto}
  .r{display:flex;gap:6px}
  .toast{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 12px;color:var(--ink);font-weight:700;opacity:0;transition:.2s}
  .toast.show{opacity:1}
  .dpad{position:absolute;left:8px;bottom:8px;display:grid;grid-template-areas:".. up .." "left . right" ".. down ..";gap:6px;place-items:center}
  .dpad button{width:52px;height:44px}
  .dpad .up{grid-area:up}.dpad .down{grid-area:down}.dpad .left{grid-area:left}.dpad .right{grid-area:right}
  .rightBtns{position:absolute;right:8px;bottom:8px;display:flex;flex-direction:column;gap:6px}
  .hint{font-size:12px;color:var(--muted)}
  .ach{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .tag{border:1px solid rgba(255,255,255,.15);color:var(--muted);padding:4px 8px;border-radius:999px;font-size:11px}
  @media (max-width:760px){ .grid{grid-template-columns:1fr} .shop{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Aero Dash endless runner">
  <header>
    <div class="row">
      <div class="pill">Best: <b id="bestOut">0</b></div>
      <div class="pill">Coins: <b id="coinsOut">0</b></div>
      <div class="pill">Daily Best: <b id="dailyOut">0</b></div>
      <div class="pill">Seed: <b id="seedOut">‚Äî</b></div>
    </div>
    <div class="row">
      <button id="btnDaily" class="secondary" aria-label="Play Daily Challenge">Daily</button>
      <button id="btnSettings" class="secondary" aria-label="Settings">‚öôÔ∏è</button>
      <button id="btnInstall" class="secondary" aria-label="Install App" hidden>‚¨áÔ∏è Install</button>
      <button id="btnSound" class="secondary" aria-label="Sound">üîä</button>
    </div>
  </header>

  <div class="wrap" id="wrap">
    <canvas id="game" width="480" height="800" aria-label="Game canvas"></canvas>

    <!-- Top HUD inside canvas frame for a11y / clicks -->
    <div class="top">
      <div class="hud">
        <div class="pill">Score: <b id="scoreHUD">0</b></div>
        <div class="pill">Speed: <b id="speedHUD">1.0x</b></div>
        <div class="pill">Combo: <b id="comboHUD">1x</b></div>
      </div>
      <div class="r">
        <button id="btnPause" class="secondary">‚è∏</button>
      </div>
    </div>

    <!-- Overlays -->
    <div class="overlay" id="menuLayer">
      <div class="panel">
        <h1>üõ©Ô∏è Aero Dash</h1>
        <p>Swipe / tap lanes to dodge, collect coins, chase combos & powerups. Daily Challenge resets every day.</p>
        <div class="row" style="justify-content:center;margin-bottom:8px">
          <button id="btnPlay">Play</button>
          <button id="btnShop" class="secondary">Shop</button>
          <button id="btnHow" class="ghost">How to play</button>
        </div>
        <div class="grid">
          <div class="panel" style="background:rgba(255,255,255,.03)">
            <h3 style="margin:0 0 6px">Daily Quests</h3>
            <div id="quests"></div>
          </div>
          <div class="panel" style="background:rgba(255,255,255,.03)">
            <h3 style="margin:0 0 6px">Achievements</h3>
            <div class="ach" id="ach"></div>
          </div>
        </div>
        <div class="hint">Tip: near-misses raise your combo. High combos = huge scores.</div>
      </div>
    </div>

    <div class="overlay" id="howLayer" hidden>
      <div class="panel">
        <h1>How to play</h1>
        <p>Move between lanes. Avoid red hazards. Grab ü™ô coins. Powerups: üõ°Ô∏è Shield, üß≤ Magnet, ‚ö° Boost.</p>
        <p>Controls: swipe / tap lane ‚Ä¢ arrows / A D ‚Ä¢ pause ‚è∏</p>
        <div class="row"><button id="btnHowBack" class="secondary">Back</button></div>
      </div>
    </div>

    <div class="overlay" id="shopLayer" hidden>
      <div class="panel">
        <h1>üõçÔ∏è Shop</h1>
        <div id="skins" class="shop"></div>
        <div class="row" style="justify-content:center;margin-top:8px"><button id="btnShopBack" class="secondary">Back</button></div>
      </div>
    </div>

    <div class="overlay" id="pauseLayer" hidden>
      <div class="panel">
        <h1>‚è∏ Paused</h1>
        <p class="muted">Take a breather. Powerups await.</p>
        <div class="row" style="justify-content:center">
          <button id="btnResume">Resume</button>
          <button id="btnPauseShop" class="secondary">Shop</button>
          <button id="btnPauseMenu" class="ghost">Menu</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="overLayer" hidden>
      <div class="panel">
        <h1>üí• Game Over</h1>
        <p>Score: <b id="finalScore">0</b> ¬∑ Best: <b id="finalBest">0</b></p>
        <div class="row" style="justify-content:center">
          <button id="btnRevive" class="warn">Watch Ad to Revive</button>
          <button id="btnRetry">Retry</button>
        </div>
        <div class="row" style="justify-content:center;margin-top:8px">
          <button id="btnShare" class="secondary">Share Score Card</button>
          <button id="btnOverShop" class="secondary">Shop</button>
          <button id="btnOverMenu" class="ghost">Menu</button>
        </div>
        <div class="hint muted">‚ÄúWatch Ad‚Äù is a stub: plug AdMob/IronSource SDK.</div>
      </div>
    </div>

    <!-- On-screen controls for mobile -->
    <div class="dpad" aria-hidden="true">
      <button class="up" disabled>‚ñ≤</button>
      <button class="left">‚óÄ</button>
      <button class="right">‚ñ∂</button>
      <button class="down" disabled>‚ñº</button>
    </div>
    <div class="rightBtns" aria-hidden="true">
      <button id="btnBoost" class="secondary">‚ö°</button>
      <button id="btnShield" class="secondary">üõ°Ô∏è</button>
    </div>

    <div class="toast" id="toast">Saved!</div>
  </div>

  <footer>
    <div class="row">
      <span class="pill">v1.0 ‚Ä¢ Hybrid-casual ‚Ä¢ PWA ‚Ä¢ Offline</span>
    </div>
    <div class="row">
      <span class="pill">Monetization hooks ready: Ad revive ‚Ä¢ Remove Ads ‚Ä¢ Cosmetic skins</span>
    </div>
  </footer>
</div>

<script>
/* ==========================================================
   AERO DASH ‚Äî Ultimate Runner (single-file, no deps)
   Features: swipe/tap, powerups, combos, shop/skins, quests, achievements,
   daily challenge (seeded), local leaderboards, share card, PWA offline, ghost replay.
   ========================================================== */

/* ---------- Utilities ---------- */
const $ = s=>document.querySelector(s);
const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
const lerp=(a,b,t)=>a+(b-a)*t;
function haptic(ms=20){ navigator.vibrate?.(ms); }

/* Seeded RNG (xorshift32) */
function makeRNG(seed=123456789){ let x=seed|0||88675123; return ()=>{ x^=x<<13; x^=x>>>17; x^=x<<5; return (x>>>0)/4294967296; }; }
function seedFrom(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function todaySeed(){ const d=new Date(); const s=`${d.getUTCFullYear()}${(d.getUTCMonth()+1+'').padStart(2,'0')}${(d.getUTCDate()+'').padStart(2,'0')}`; return {str:s, val:seedFrom(s)}; }

/* Storage */
const SAVE_KEY='aero_dash_v1';
const Store={
  load(){ try{ return JSON.parse(localStorage.getItem(SAVE_KEY)) || {coins:0,best:0,dailyBest:0,unlocked:['classic'],skin:'classic',sound:true,ghost:null,quests:{},ach:[]}; }catch(e){return {coins:0,best:0,dailyBest:0,unlocked:['classic'],skin:'classic',sound:true,ghost:null,quests:{},ach:[]}; }},
  save(d){ localStorage.setItem(SAVE_KEY, JSON.stringify(d)); toast('Saved'); }
};
let save = Store.load();

/* ---------- Game constants ---------- */
const canvas = $('#game'); const ctx = canvas.getContext('2d');
const W=canvas.width, H=canvas.height;
const LANES=3, laneW=W/LANES, groundY=H*0.82;
const BASE_SPEED=210, RAMP=0.015, MAX_SPEED=760;
const PLAYER_SPEED=820;
const OBST_EVERY=750, COIN_EVERY=320, PWR_EVERY=4500;
const MAX_OBS=7;
const POWERUP_DUR=6000;

const SKINS = [
  {id:'classic', name:'Classic', color:'#5ac8fa', price:0},
  {id:'sunset',  name:'Sunset', color:'#ff8a5c', price:150},
  {id:'mint',    name:'Mint',   color:'#2ecc71', price:180},
  {id:'violet',  name:'Violet', color:'#b97cff', price:220},
  {id:'golden',  name:'Golden', color:'#ffd54a', price:300},
  {id:'crimson', name:'Crimson',color:'#ff5d73', price:350},
];

/* Quests (reset daily by date key) */
const DEFAULT_QUESTS = [
  {id:'run',   text:'Run 1200m', goal:1200, prog:0, reward:60},
  {id:'coins', text:'Collect 80 coins', goal:80, prog:0, reward:50},
  {id:'near',  text:'10 near-misses', goal:10, prog:0, reward:40},
];

/* Achievements */
const ACH = new Set(save.ach||[]);

/* ---------- Audio (tiny bleeps) ---------- */
let actx=null;
function audioOn(){ if(!save.sound) return; if(!actx) actx=new (window.AudioContext||window.webkitAudioContext)(); }
function beep(f=440, d=0.05, t='sine', g0=0.12){
  if(!save.sound) return;
  audioOn(); if(!actx) return;
  const o=actx.createOscillator(), g=actx.createGain(); o.type=t; o.frequency.value=f; o.connect(g); g.connect(actx.destination);
  const t0=actx.currentTime; g.gain.setValueAtTime(g0,t0); g.gain.exponentialRampToValueAtTime(0.0001,t0+d); o.start(t0); o.stop(t0+d);
}

/* ---------- Entities ---------- */
class Player {
  constructor(){ this.lane=1; this.x=this.lane*laneW+laneW/2; this.y=groundY; this.size=20; this.targetLane=this.lane; this.alive=true; this.skin=save.skin||'classic'; this.shield=0; this.magnet=0; this.boost=0; }
  setSkin(id){ this.skin=id; }
  setLaneByX(px){ const l=clamp((px/laneW)|0,0,LANES-1); this.targetLane=l; }
  moveDir(d){ this.targetLane=clamp(this.targetLane+d,0,LANES-1); }
  update(dt){
    const targetX=this.targetLane*laneW+laneW/2;
    const dx=targetX-this.x; const step=Math.min(Math.abs(dx), PLAYER_SPEED*dt)*Math.sign(dx);
    this.x+=step;
    if(this.shield>0) this.shield-=dt*1000;
    if(this.magnet>0) this.magnet-=dt*1000;
    if(this.boost>0) this.boost-=dt*1000;
  }
  draw(){
    const skin = SKINS.find(s=>s.id===this.skin) || SKINS[0];
    ctx.save();
    // trail glow
    ctx.shadowColor=skin.color; ctx.shadowBlur=18; ctx.fillStyle=skin.color;
    ctx.beginPath();
    ctx.moveTo(this.x, this.y-this.size);
    ctx.lineTo(this.x-this.size*0.7, this.y+this.size*0.9);
    ctx.lineTo(this.x+this.size*0.7, this.y+this.size*0.9);
    ctx.closePath(); ctx.fill();
    if(this.shield>0){
      ctx.shadowBlur=0; ctx.strokeStyle='rgba(91,225,255,.8)'; ctx.lineWidth=3;
      ctx.beginPath(); ctx.arc(this.x,this.y,this.size*1.2,0,Math.PI*2); ctx.stroke();
    }
    ctx.restore();
  }
  hitbox(){ return {x:this.x, y:this.y-4, r:this.size*0.85}; }
}

class Obstacle {
  constructor(lane,y,s){ this.lane=lane; this.x=lane*laneW+laneW*0.5; this.y=y; this.w=laneW*0.72; this.h=18+Math.random()*16; this.s=s; this.type=Math.random()<0.2?'moving':'static'; this.phase=Math.random()*Math.PI*2; this.alive=true; }
  update(dt){
    this.y+=this.s*dt*(player.boost>0?1.4:1);
    if(this.type==='moving'){ this.x=this.lane*laneW+laneW*0.5 + Math.sin(this.phase+performance.now()/450)*laneW*0.18; }
    if(this.y>H+40) this.alive=false;
  }
  draw(){
    ctx.save();
    ctx.fillStyle='rgba(255,93,115,.95)'; roundRect(this.x-this.w/2,this.y-this.h/2,this.w,this.h,8); ctx.fill();
    ctx.restore();
  }
  hitbox(){ return {x:this.x, y:this.y, w:this.w, h:this.h}; }
}
class Coin {
  constructor(lane,y,s){ this.lane=lane; this.x=lane*laneW+laneW*0.5; this.y=y; this.r=10; this.s=s; this.alive=true; this.spin=Math.random()*Math.PI*2; }
  update(dt){
    this.y+=this.s*dt; this.spin+=dt*6;
    if(player.magnet>0){ const dx=player.x-this.x, dy=(player.y-6)-this.y; const d=Math.hypot(dx,dy); const f=clamp(1200/(d+1),0,1200); this.x+=dx/d*f*dt; this.y+=dy/d*f*dt; }
    if(this.y>H+30) this.alive=false;
  }
  draw(){
    ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(Math.sin(this.spin)*0.6);
    ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fillStyle='#ffd54a'; ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=2; ctx.stroke();
    ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(-this.r*0.2,-this.r*0.7,this.r*0.4,this.r*1.4);
    ctx.restore();
  }
  hitbox(){ return {x:this.x,y:this.y,r:this.r*0.9}; }
}
class Power {
  constructor(kind,lane,y,s){ this.kind=kind; this.lane=lane; this.x=lane*laneW+laneW/2; this.y=y; this.s=s; this.alive=true; }
  update(dt){ this.y+=this.s*dt; if(this.y>H+30) this.alive=false; }
  draw(){
    ctx.save(); ctx.translate(this.x,this.y);
    ctx.fillStyle= this.kind==='shield'? '#5be1ff' : (this.kind==='magnet'?'#ffcc66':'#9dff8a');
    ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#001018'; ctx.font='bold 12px ui-sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(this.kind==='shield'?'üõ°Ô∏è':(this.kind==='magnet'?'üß≤':'‚ö°'),0,1);
    ctx.restore();
  }
  hitbox(){ return {x:this.x,y:this.y,r:12}; }
}

/* ---------- Geometry ---------- */
function circleRect(c,r){ const cx=clamp(c.x, r.x-r.w/2, r.x+r.w/2); const cy=clamp(c.y, r.y-r.h/2, r.y+r.h/2); const dx=c.x-cx, dy=c.y-cy; return (dx*dx+dy*dy)<=c.r*c.r; }
function circleCircle(a,b){ const dx=a.x-b.x, dy=a.y-b.y; const rr=(a.r+b.r)*(a.r+b.r); return dx*dx+dy*dy<=rr; }
function roundRect(x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }

/* ---------- Game state ---------- */
const HUD={score:$('#scoreHUD'), speed:$('#speedHUD'), combo:$('#comboHUD'), best:$('#bestOut'), coins:$('#coinsOut'), daily:$('#dailyOut'), seed:$('#seedOut'), finalScore:$('#finalScore'), finalBest:$('#finalBest')};

const Lyr={menu:$('#menuLayer'), how:$('#howLayer'), shop:$('#shopLayer'), pause:$('#pauseLayer'), over:$('#overLayer')};
const Btn={play:$('#btnPlay'), daily:$('#btnDaily'), shop:$('#btnShop'), how:$('#btnHow'), howBack:$('#btnHowBack'), shopBack:$('#btnShopBack'),
  pause:$('#btnPause'), resume:$('#btnResume'), pauseMenu:$('#btnPauseMenu'), pauseShop:$('#btnPauseShop'),
  retry:$('#btnRetry'), overMenu:$('#btnOverMenu'), overShop:$('#btnOverShop'), revive:$('#btnRevive'),
  sound:$('#btnSound'), settings:$('#btnSettings'), share:$('#btnShare'), install:$('#btnInstall'),
  left:document.querySelector('.dpad .left'), right:document.querySelector('.dpad .right'),
  shield:$('#btnShield'), boost:$('#btnBoost')
};

let state='menu';
let player, obstacles=[], coins=[], powers=[];
let score=0, coinsRun=0, combo=1, comboTimer=0, speedMul=1, rng=Math.random, seedStr='‚Äî', dailyMode=false;
let tLast=0, tOb=0, tCoin=0, tPow=0, reviveAvail=true, ghost=null;

/* Quests runtime */
function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
function ensureQuests(){
  const key=todayKey();
  if(!save.quests[key]) save.quests[key]=JSON.parse(JSON.stringify(DEFAULT_QUESTS));
}
function questTick(type,val){
  ensureQuests();
  const qs=save.quests[todayKey()];
  for(const q of qs){
    if(q.id==='run' && type==='dist') q.prog=Math.min(q.goal, (q.prog||0)+val);
    if(q.id==='coins' && type==='coin') q.prog=Math.min(q.goal, (q.prog||0)+val);
    if(q.id==='near' && type==='near') q.prog=Math.min(q.goal, (q.prog||0)+val);
  }
  // rewards
  let rewarded=false;
  for(const q of qs){ if(!q.done && q.prog>=q.goal){ q.done=true; save.coins=(save.coins||0)+q.reward; rewarded=true; badge(`Quest complete: ${q.text} +${q.reward}ü™ô`); } }
  if(rewarded){ Store.save(save); refreshHUD(); renderQuests(); }
}

/* Achievements badges */
const achEl=$('#ach');
function badge(name){ const tag=document.createElement('div'); tag.className='tag'; tag.textContent='üèÖ '+name; achEl.appendChild(tag); if(!ACH.has(name)){ ACH.add(name); save.ach=[...ACH]; Store.save(save);} }

/* Shop build */
function buildShop(){
  const grid=$('#skins'); grid.innerHTML='';
  for(const s of SKINS){
    const owned=(save.unlocked||[]).includes(s.id);
    const el=document.createElement('div'); el.className='skin';
    el.innerHTML=`<div class="preview" style="background:linear-gradient(135deg, ${s.color}33, transparent)"><div style="width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:24px solid ${s.color};filter:drop-shadow(0 6px 12px ${s.color}88)"></div></div>
      <div class="meta"><span>${s.name}</span><span>${s.price?`<span class="coin">ü™ô ${s.price}</span>`:'<span class="muted">Owned</span>'}</span></div>
      <div class="row" style="margin-top:6px;justify-content:center">${owned?`<button data-equip="${s.id}">Equip</button>`:`<button data-buy="${s.id}">Buy</button>`}</div>`;
    grid.appendChild(el);
    el.addEventListener('click',(e)=>{
      const buy=e.target.getAttribute('data-buy'); const eq=e.target.getAttribute('data-equip');
      if(buy) buySkin(buy);
      if(eq) equipSkin(eq);
    });
  }
}
function buySkin(id){
  const s=SKINS.find(x=>x.id===id); if(!s) return;
  if((save.coins||0)<s.price){ beep(160,0.08,'sawtooth'); toast('Not enough coins'); return; }
  save.coins-=s.price; (save.unlocked||[]).push(id); equipSkin(id); Store.save(save); refreshHUD(); buildShop(); beep(520,0.06,'triangle'); badge('Collector I');
}
function equipSkin(id){ save.skin=id; if(player) player.setSkin(id); Store.save(save); buildShop(); }

/* HUD & UI */
function refreshHUD(){
  HUD.best.textContent=save.best||0; HUD.coins.textContent=save.coins||0; HUD.daily.textContent=save.dailyBest||0; HUD.seed.textContent=seedStr;
}
function renderQuests(){
  ensureQuests(); const qs=save.quests[todayKey()];
  const c=$('#quests'); c.innerHTML='';
  for(const q of qs){
    const pct=(q.prog/q.goal*100)|0;
    const row=document.createElement('div'); row.style.margin='6px 0';
    row.innerHTML=`<div class="row" style="justify-content:space-between"><b>${q.text}</b><span class="muted">${q.prog}/${q.goal} ‚Ä¢ ü™ô${q.reward}</span></div>
      <div style="height:8px;background:rgba(255,255,255,.08);border-radius:8px;overflow:hidden"><div style="height:100%;width:${pct}%;background:linear-gradient(90deg,#2ecc71,#5ac8fa)"></div></div>`;
    c.appendChild(row);
  }
}

/* Toast */
const toastEl=$('#toast');
function toast(t){ toastEl.textContent=t; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1200); }

/* Overlays */
function show(layer){ Object.values(Lyr).forEach(el=>el.hidden=true); layer.hidden=false; }
function menu(){ state='menu'; show(Lyr.menu); renderQuests(); buildShop(); }

/* ---------- Game control ---------- */
function resetRun(){
  player=new Player(); obstacles=[]; coins=[]; powers=[];
  score=0; coinsRun=0; combo=1; comboTimer=0; speedMul=1; tLast=performance.now(); tOb=0; tCoin=0; tPow=0; reviveAvail=true;
  ghost = save.ghost && save.ghost.seed===seedStr ? {...save.ghost, idx:0, y:groundY} : null;
}
function startRun(daily=false){
  dailyMode=daily;
  // seed
  if(daily){ const d=todaySeed(); seedStr=d.str; rng=makeRNG(d.val); } else { const s=(Date.now().toString(36)); seedStr=s; rng=makeRNG(seedFrom(s)); }
  resetRun(); refreshHUD(); state='run'; Object.values(Lyr).forEach(el=>el.hidden=true);
}

function endRun(){
  state='over';
  const s=Math.floor(score);
  // save bests
  save.best=Math.max(save.best||0,s);
  if(dailyMode) save.dailyBest=Math.max(save.dailyBest||0,s);
  save.coins=(save.coins||0)+ (coinsRun + Math.floor(score/150));
  // record ghost (lane timeline every 120ms)
  save.ghost = { seed:seedStr, lanes:ghostTimeline, skin:save.skin };
  Store.save(save); refreshHUD();
  HUD.finalScore.textContent=s; HUD.finalBest.textContent=save.best;
  show(Lyr.over);
}

let ghostTimeline=[]; let ghostTick=0;

/* ---------- Loop ---------- */
function loop(){
  requestAnimationFrame(loop);
  if(state!=='run'){ renderBg(0); return; }
  const t=performance.now(); const dt=Math.min((t-tLast)/1000, 0.033); tLast=t;

  // speed ramp
  const boostMul=(player.boost>0)?1.25:1;
  speedMul = Math.min(MAX_SPEED/BASE_SPEED, speedMul + RAMP*dt*boostMul);
  HUD.speed.textContent=(speedMul).toFixed(1)+'x';

  // spawns
  tOb+=dt*1000; tCoin+=dt*1000; tPow+=dt*1000;
  if(tOb>OBST_EVERY/Math.min(2.0,speedMul)){ tOb=0; if(obstacles.length<MAX_OBS) obstacles.push(new Obstacle((rng()*LANES)|0, -30, BASE_SPEED*speedMul)); }
  if(tCoin>COIN_EVERY/Math.min(2.2,speedMul)){ tCoin=0; coins.push(new Coin((rng()*LANES)|0, -30, BASE_SPEED*speedMul*0.9)); }
  if(tPow>PWR_EVERY){ tPow=0; const kinds=['shield','magnet','boost']; powers.push(new Power(kinds[(rng()*kinds.length)|0], (rng()*LANES)|0, -30, BASE_SPEED*speedMul*0.85)); }

  // update
  player.update(dt);
  for(const o of obstacles) o.update(dt);
  for(const c of coins) c.update(dt);
  for(const p of powers) p.update(dt);
  obstacles=obstacles.filter(o=>o.alive);
  coins=coins.filter(c=>c.alive);
  powers=powers.filter(p=>p.alive);

  // collisions
  for(const o of obstacles){
    if(circleRect(player.hitbox(), o.hitbox())){
      if(player.shield>0){ player.shield=0; o.alive=false; beep(420,0.06,'triangle'); haptic(25); }
      else { beep(140,0.09,'sawtooth'); haptic(35); endRun(); return; }
    }
    // near-miss?
    const dy=Math.abs(o.y-player.y); const dx=Math.abs(o.x-player.x);
    if(dy<28 && dx<(o.w/2+player.size) && dy>12){ combo=Math.min(8, combo+0.05); comboTimer=2200; }
  }
  for(const c of coins){ if(circleCircle(player.hitbox(), c.hitbox())){ c.alive=false; coinsRun++; beep(760,0.03,'square',0.08); haptic(10); questTick('coin',1); } }
  for(const p of powers){ if(circleCircle(player.hitbox(), p.hitbox())){ p.alive=false; if(p.kind==='shield') player.shield=POWERUP_DUR; if(p.kind==='magnet') player.magnet=POWERUP_DUR; if(p.kind==='boost') player.boost=POWERUP_DUR*0.7; beep(540,0.07,'triangle'); haptic(20); } }

  // scoring & combo
  const dist=dt*(60*speedMul);
  score += dist * (1 + (combo-1)*0.2);
  HUD.score.textContent = String(Math.floor(score));
  HUD.combo.textContent = (combo).toFixed(1)+'x';
  questTick('dist', dist);
  if(comboTimer>0){ comboTimer-=dt*1000; } else { combo=Math.max(1, combo-0.02); }

  // record ghost lane every 120ms
  ghostTick+=dt*1000; if(ghostTick>120){ ghostTick=0; ghostTimeline.push(player.targetLane); if(ghostTimeline.length>1500) ghostTimeline.shift(); }

  // render
  renderBg(speedMul*(player.boost>0?1.4:1));
  renderWorld();
}

/* ---------- Rendering ---------- */
function renderBg(speed=1){
  ctx.clearRect(0,0,W,H);
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#0d1426'); g.addColorStop(1,'#090e19');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // lane lines
  for(let i=1;i<LANES;i++){ ctx.strokeStyle='rgba(255,255,255,.06)'; ctx.lineWidth=1; ctx.setLineDash([8,12]); ctx.beginPath(); ctx.moveTo(i*laneW,0); ctx.lineTo(i*laneW,H); ctx.stroke(); ctx.setLineDash([]); }

  // parallax scanlines
  const gap=38; const off=(performance.now()/16*speed)%gap; ctx.strokeStyle='rgba(255,255,255,.05)'; ctx.lineWidth=2;
  for(let y=-off; y<H; y+=gap){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
}
function renderWorld(){
  for(const c of coins) c.draw();
  for(const p of powers) p.draw();
  for(const o of obstacles) o.draw();

  // ghost (personal best lane playback)
  if(ghost && ghost.lanes && ghost.idx<ghost.lanes.length){
    const lane=ghost.lanes[ghost.idx]; const x=lane*laneW+laneW/2;
    ctx.save(); ctx.globalAlpha=0.28; ctx.fillStyle='#fff'; ctx.beginPath();
    ctx.moveTo(x, groundY-20); ctx.lineTo(x-14,groundY+18); ctx.lineTo(x+14,groundY+18); ctx.closePath(); ctx.fill(); ctx.restore();
    if(Math.random()<0.08) ghost.idx++; // drift playback gradually
  }

  player.draw();
}

/* ---------- Input ---------- */
function goLeft(){ if(state==='run'){ player.moveDir(-1); } }
function goRight(){ if(state==='run'){ player.moveDir(1); } }

window.addEventListener('keydown', e=>{
  if(state==='menu' && (e.key==='Enter'||e.key===' ')) return startRun(false);
  if(state!=='run') return;
  if(e.key==='ArrowLeft'||e.key==='a') goLeft();
  if(e.key==='ArrowRight'||e.key==='d') goRight();
  if(e.key==='Escape'){ pause(); }
});

let touching=false;
canvas.addEventListener('touchstart', e=>{ if(state==='menu'){ startRun(false); return; } touching=true; const rect=canvas.getBoundingClientRect(); const x=(e.touches[0].clientX-rect.left)*(W/rect.width); player.setLaneByX(x); }, {passive:true});
canvas.addEventListener('touchmove', e=>{ if(!touching)return; const rect=canvas.getBoundingClientRect(); const x=(e.touches[0].clientX-rect.left)*(W/rect.width); player.setLaneByX(x); }, {passive:true});
canvas.addEventListener('touchend', ()=>{ touching=false; }, {passive:true});

Btn.left.onclick=goLeft; Btn.right.onclick=goRight;

/* ---------- Pause / Revive ---------- */
function pause(){ if(state==='run'){ state='pause'; show(Lyr.pause); } }
Btn.pause.onclick=pause;
Btn.resume.onclick=()=>{ state='run'; Object.values(Lyr).forEach(el=>el.hidden=true); };
Btn.pauseMenu.onclick=menu;
Btn.pauseShop.onclick=()=>{ show(Lyr.shop); buildShop(); };

Btn.retry.onclick=()=> startRun(dailyMode);
Btn.overMenu.onclick=menu;
Btn.overShop.onclick=()=>{ show(Lyr.shop); buildShop(); };
Btn.revive.onclick=()=>{
  // Rewarded ad hook (simulate 80% success)
  const ok=Math.random()<0.8;
  if(ok && reviveAvail){ reviveAvail=false; player.shield=1600; state='run'; Object.values(Lyr).forEach(el=>el.hidden=true); beep(520,0.08,'square'); }
  else { Btn.revive.disabled=true; beep(140,0.08,'sawtooth'); }
};

/* ---------- Buttons ---------- */
Btn.play.onclick=()=> startRun(false);
Btn.daily.onclick=()=> { const d=todaySeed(); seedStr=d.str; startRun(true); };
Btn.shop.onclick=()=>{ show(Lyr.shop); buildShop(); };
Btn.how.onclick=()=> show(Lyr.how);
Btn.howBack.onclick=menu;
Btn.shopBack.onclick=menu;
Btn.sound.onclick=()=>{ save.sound=!save.sound; Btn.sound.textContent=save.sound?'üîä':'üîá'; Store.save(save); if(save.sound) beep(880,0.03,'sine'); };
Btn.shield.onclick=()=>{ if(state==='run'){ player.shield=Math.max(player.shield, 2200); beep(480,0.06,'triangle'); } };
Btn.boost.onclick=()=>{ if(state==='run'){ player.boost=Math.max(player.boost, 1800); beep(600,0.06,'triangle'); } };

/* ---------- Shareable score card ---------- */
Btn.share.onclick=()=>{
  const card=document.createElement('canvas'); const c=card.getContext('2d'); card.width=900; card.height=500;
  // bg
  const g=c.createLinearGradient(0,0,900,500); g.addColorStop(0,'#0d1426'); g.addColorStop(1,'#08111f'); c.fillStyle=g; c.fillRect(0,0,900,500);
  c.fillStyle='#eaf2ff'; c.font='bold 40px system-ui,Segoe UI'; c.fillText('Aero Dash ‚Äî Score Card', 30, 60);
  c.font='700 28px system-ui'; c.fillText(`Score: ${Math.floor(score)}`, 30, 120);
  c.fillStyle='#ffd54a'; c.fillText(`Coins: ${coinsRun + Math.floor(score/150)}`, 30, 170);
  c.fillStyle='#8fa3c1'; c.fillText(`Seed: ${seedStr}${dailyMode?' (Daily)':''}`, 30, 220);
  // ship
  const skin=SKINS.find(s=>s.id===save.skin)||SKINS[0];
  c.save(); c.translate(720,260); c.shadowColor=skin.color; c.shadowBlur=24; c.fillStyle=skin.color;
  c.beginPath(); c.moveTo(0,-60); c.lineTo(-42,54); c.lineTo(42,54); c.closePath(); c.fill(); c.restore();
  // link hint
  c.fillStyle='#8fa3c1'; c.font='600 22px system-ui'; c.fillText('Play: save & open aero-dash.html', 30, 280);
  // achievements
  c.fillStyle='#eaf2ff'; c.font='700 24px system-ui'; c.fillText('Achievements:', 30, 330);
  c.font='600 22px system-ui'; let y=360; const arr=[...ACH]; if(!arr.length) arr.push('None yet ‚Äî go get some!');
  for(const a of arr.slice(0,4)){ c.fillText('üèÖ '+a, 30, y); y+=32; }
  const url=card.toDataURL('image/png');
  const a=document.createElement('a'); a.href=url; a.download='aero-dash-score.png'; a.click();
};

/* ---------- Settings / Install (PWA) ---------- */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; Btn.install.hidden=false; });
Btn.install.onclick=async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); deferredPrompt=null; Btn.install.hidden=true; };

Btn.settings.onclick=()=>alert('Settings:\n‚Ä¢ Toggle sound (button in header)\n‚Ä¢ Add to Home Screen (Install)\n‚Ä¢ Performance: If laggy, use browser menu ‚Üí Request Desktop Site off, close other tabs.');

/* ---------- Daily leaderboard (local) ---------- */
// (We keep it simple: save daily best; future: integrate backend)

/* ---------- Boot ---------- */
function boot(){
  refreshHUD(); renderQuests(); buildShop(); buildAchievementsView(); Btn.sound.textContent=save.sound?'üîä':'üîá'; menu(); loop(); registerSW();
}
function buildAchievementsView(){ achEl.innerHTML=''; for(const a of ACH) badge(a); }

/* ---------- Service Worker (inline) ---------- */
function registerSW(){
  if(!('serviceWorker' in navigator)) return;
  const swCode = `
    const CACHE='aero-dash-v1';
    self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll([self.location.href]))); self.skipWaiting(); });
    self.addEventListener('activate',e=>{ e.waitUntil(self.clients.claim()); });
    self.addEventListener('fetch',e=>{ e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{ if(e.request.mode==='navigate'){ const copy=res.clone(); caches.open(CACHE).then(c=>c.put(self.location.href,copy)); } return res; }))); });
  `;
  const blob=new Blob([swCode],{type:'text/javascript'}); const url=URL.createObjectURL(blob);
  navigator.serviceWorker.register(url).catch(()=>{});
}

/* ---------- Start ---------- */
boot();
</script>
</body>
</html>
